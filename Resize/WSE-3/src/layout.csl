param P_1: i16;
param P_2: i16;
param Mt_1: i16;
param Nt_1: i16;
param Mt_2: i16;
param Nt_2: i16;

const C_R_0: color = @get_color(1);
const C_R_1: color = @get_color(2);

const C_D_0: color = @get_color(3);
const C_D_1: color = @get_color(4);

const C_U_B: color = @get_color(5);
const C_L_B: color = @get_color(6);

const memcpy = @import_module( "<memcpy/get_params>", .{
    .width = P_2,
    .height = P_2,
});

const comm = @import_module("comm_lib/comm_layout.csl", .{
    .P_2 = P_2,
    .x_colors = [2]color{C_R_0, C_R_1},
    .y_colors = [2]color{C_D_0, C_D_1},
});

layout {

    @comptime_assert(P_2 >= P_1);

    @set_rectangle(P_2, P_2);

    var px: i16 = 0;
    var py: i16 = 0;

    const comm_even_even = comm.get_step_params(true, true);
    const comm_even_odd = comm.get_step_params(true, false);
    const comm_odd_even = comm.get_step_params(false, true);
    const comm_odd_odd = comm.get_step_params(false, false);

    px = 0;
    while (px < P_2) : (px += 2) {
        const memcpy_params = memcpy.get_params(px);

        py = 0;
        while (py < P_2) : (py += 2) {

            @set_tile_code(px, py, "resize.csl", .{
                .memcpy_params = memcpy_params,
                .comm_params = @concat_structs(comm_even_even, .{
                    .up_bd_color = C_U_B, .left_bd_color = C_L_B,
                }),
                .P_1 = P_1, .P_2 = P_2, .Mt_1 = Mt_1, .Nt_1 = Nt_1, .Mt_2 = Mt_2, .Nt_2 = Nt_2,
            });

            {
                @set_color_config(px, py, comm_even_even.c_right_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{EAST} } });
                @set_color_config(px, py, comm_even_even.c_right_recv, .{ .routes = .{ .rx = .{WEST}, .tx = .{RAMP} } });

                @set_color_config(px, py, comm_even_even.c_down_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{SOUTH} } });
                @set_color_config(px, py, comm_even_even.c_down_recv, .{ .routes = .{ .rx = .{NORTH}, .tx = .{RAMP} } });
            }

        }

        py = 1;
        while (py < P_2) : (py += 2) {

            @set_tile_code(px, py, "resize.csl", .{
                .memcpy_params = memcpy_params,
                .comm_params = @concat_structs(comm_even_odd, .{
                    .up_bd_color = C_U_B, .left_bd_color = C_L_B,
                }),
                .P_1 = P_1, .P_2 = P_2, .Mt_1 = Mt_1, .Nt_1 = Nt_1, .Mt_2 = Mt_2, .Nt_2 = Nt_2,
            });

            {
                @set_color_config(px, py, comm_even_odd.c_right_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{EAST} } });
                @set_color_config(px, py, comm_even_odd.c_right_recv, .{ .routes = .{ .rx = .{WEST}, .tx = .{RAMP} } });

                @set_color_config(px, py, comm_even_odd.c_down_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{SOUTH} } });
                @set_color_config(px, py, comm_even_odd.c_down_recv, .{ .routes = .{ .rx = .{NORTH}, .tx = .{RAMP} } });
            }

        }

    }

    px = 1;
    while (px < P_2) : (px += 2) {
        const memcpy_params = memcpy.get_params(px);

        py = 0;
        while (py < P_2) : (py += 2) {

            @set_tile_code(px, py, "resize.csl", .{
                .memcpy_params = memcpy_params,
                .comm_params = @concat_structs(comm_odd_even, .{
                    .up_bd_color = C_U_B, .left_bd_color = C_L_B,
                }),
                .P_1 = P_1, .P_2 = P_2, .Mt_1 = Mt_1, .Nt_1 = Nt_1, .Mt_2 = Mt_2, .Nt_2 = Nt_2,
            });

            {
                @set_color_config(px, py, comm_odd_even.c_right_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{EAST} } });
                @set_color_config(px, py, comm_odd_even.c_right_recv, .{ .routes = .{ .rx = .{WEST}, .tx = .{RAMP} } });

                @set_color_config(px, py, comm_odd_even.c_down_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{SOUTH} } });
                @set_color_config(px, py, comm_odd_even.c_down_recv, .{ .routes = .{ .rx = .{NORTH}, .tx = .{RAMP} } });
            }

        }

        py = 1;
        while (py < P_2) : (py += 2) {

            @set_tile_code(px, py, "resize.csl", .{
                .memcpy_params = memcpy_params,
                .comm_params = @concat_structs(comm_odd_odd, .{
                    .up_bd_color = C_U_B, .left_bd_color = C_L_B,
                }),
                .P_1 = P_1, .P_2 = P_2, .Mt_1 = Mt_1, .Nt_1 = Nt_1, .Mt_2 = Mt_2, .Nt_2 = Nt_2,
            });

            {
                @set_color_config(px, py, comm_odd_odd.c_right_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{EAST} } });
                @set_color_config(px, py, comm_odd_odd.c_right_recv, .{ .routes = .{ .rx = .{WEST}, .tx = .{RAMP} } });

                @set_color_config(px, py, comm_odd_odd.c_down_send, .{ .routes = .{ .rx = .{RAMP}, .tx = .{SOUTH} } });
                @set_color_config(px, py, comm_odd_odd.c_down_recv, .{ .routes = .{ .rx = .{NORTH}, .tx = .{RAMP} } });
            }

        }
    }

}